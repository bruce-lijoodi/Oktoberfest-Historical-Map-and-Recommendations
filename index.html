<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üç∫üçæOktoberfest History Map and Recommendationsüçæüç∫</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />

 

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        #map {
            width: 100%;
            height: 100vh;
        }
        
        .info-box {
            position: absolute;
            top: 20px;
            left: 60px;
            background-color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .info-box h2 {
            margin: 0 0 5px 0;
            font-size: 20px;
            color: #0066cc;
        }
        
        .info-box p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }
        .legend-box {
    position: absolute;
    bottom: 30px;
    right: 20px;
    background-color: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    font-family: Arial, sans-serif;
    min-width: 400px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    column-gap: 15px;
}

.legend-box h3 {
    margin: 0 0 10px 0;
    font-size: 16px;
    color: #333;
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.legend-box h3:hover {
    background-color: #e8f4f8;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    padding: 5px 8px;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.legend-item:hover {
    background-color: #f0f0f0;
}

.legend-item.inactive {
    opacity: 0.4;
}

.legend-item.inactive:hover {
    opacity: 0.6;
}

.legend-item:last-child {
    margin-bottom: 0;
}

.legend-icon {
    font-size: 20px;
    margin-right: 10px;
    width: 25px;
    text-align: center;
}

.legend-text {
    font-size: 14px;
    color: #333;
}
.timeline-slider {
    position: absolute;
    bottom: 30px;
    left: 60px;
    background-color: white;
    padding: 10px 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    font-family: Arial, sans-serif;
    min-width: 250px;
}

.timeline-slider h3 {
    margin: 0 0 8px 0;
    font-size: 14px;
    color: #333;
}

.slider-container {
    position: relative;
    height: 40px;
    margin-bottom: 10px;
}

.slider-container input[type="range"] {
    position: absolute;
    width: 100%;
    pointer-events: none;
    -webkit-appearance: none;
    background: transparent;
}

.slider-container input[type="range"]::-webkit-slider-thumb {
    pointer-events: all;
    -webkit-appearance: none;
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: #0066cc;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.slider-container input[type="range"]::-moz-range-thumb {
    pointer-events: all;
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: #0066cc;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.slider-container input[type="range"]::-webkit-slider-runnable-track {
    width: 100%;
    height: 8px;
    background: #ddd;
    border-radius: 4px;
}

.slider-container input[type="range"]::-moz-range-track {
    width: 100%;
    height: 8px;
    background: #ddd;
    border-radius: 4px;
}

.year-display {
    font-size: 14px;
    color: #333;
    font-weight: bold;
    text-align: center;
}
/* Fade out UI elements when popup is open */
.hide-ui .info-box,
.hide-ui .legend-box,
.hide-ui .timeline-slider {
    opacity: 0.2;
    pointer-events: none;
    transition: opacity 0.3s ease;
}
/* Mobile Responsive Styles */
@media screen and (max-width: 768px) {
    /* Make info box smaller and reposition */
    .info-box {
        left: 10px;
        top: 10px;
        padding: 8px 12px;
        min-width: auto;
        max-width: 200px;
    }
    
    .info-box h2 {
        font-size: 14px;
        margin: 0 0 3px 0;
    }
    
    .info-box p {
        font-size: 11px;
        display: none; /* Hide subtitle on mobile */
    }
    
    /* Make timeline slider smaller */
    .timeline-slider {
        left: 10px;
        bottom: 10px;
        padding: 8px 10px;
        min-width: auto;
        max-width: calc(100% - 20px);
    }
    
    .timeline-slider h3 {
        font-size: 12px;
        margin: 0 0 5px 0;
    }
    
    .year-display {
        font-size: 12px;
    }
    
    /* Make legend MUCH smaller and scrollable */
    .legend-box {
        right: 10px;
        bottom: 10px;
        padding: 8px 10px;
        min-width: auto;
        max-width: 150px;
        max-height: 200px;
        overflow-y: auto;
        grid-template-columns: 1fr; /* Single column on mobile */
        scrollbar-width: thin;
        scrollbar-color: #0066cc #f0f0f0;
    }
    /* Webkit browsers (Chrome, Safari, Edge) scrollbar styling */
    .legend-box::-webkit-scrollbar {
    width: 6px;
    }

    .legend-box::-webkit-scrollbar-track {
    background: #f0f0f0;
    border-radius: 3px;
    }

    .legend-box::-webkit-scrollbar-thumb {
    background: #0066cc;
    border-radius: 3px;
    }

    .legend-box::-webkit-scrollbar-thumb:hover {
    background: #004999;
    }
    /* Add fade effect at bottom of legend to hint at more content */
    .legend-box::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 30px;
    background: linear-gradient(to bottom, transparent, white);
    pointer-events: none;   
    }  
    
    .legend-box h3 {
        font-size: 12px;
        margin: 0 0 5px 0;
        padding: 3px;
    }
    
    .legend-item {
        margin-bottom: 5px;
        padding: 3px 5px;
    }
    
    .legend-icon {
        font-size: 16px;
        margin-right: 5px;
        width: 20px;
    }
    
    .legend-text {
        font-size: 11px;
    }
    
    /* Adjust marker size on mobile */
    .custom-year-marker div {
        transform: scale(0.8);
    }
}

/* Extra small phones */
@media screen and (max-width: 480px) {
    .info-box h2 {
        font-size: 12px;
    }
    
    .legend-box {
        max-width: 130px;
        max-height: 150px;
    }
    
    .legend-text {
        font-size: 10px;
    }
}
@media screen and (max-width: 768px) {
    .legend-box {
        /* existing styles... */
        box-shadow: inset 0 -15px 10px -10px rgba(0,0,0,0.1);
    }
}
/* Zoom limit notification */
.zoom-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(0, 102, 204, 0.95);
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    font-family: Arial, sans-serif;
    font-size: 14px;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.zoom-notification.show {
    opacity: 1;
}
/* Virtual Tour Button */
.virtual-tour-button {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #0066cc;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    font-family: Arial, sans-serif;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.virtual-tour-button:hover {
    background-color: #004999;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

.virtual-tour-button:active {
    transform: translateY(0);
}

/* Mobile responsive */
@media screen and (max-width: 768px) {
    .virtual-tour-button {
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        font-size: 12px;
    }
}


/* Rotation Controls */
#rotationControls {
    position: absolute;
    bottom: 70px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    display: flex;
    gap: 10px;
}

#rotationControls button {
    background-color: white;
    color: #0066cc;
    border: 2px solid #0066cc;
    padding: 10px 15px;
    border-radius: 8px;
    font-family: Arial, sans-serif;
    font-size: 13px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}

#rotationControls button:hover {
    background-color: #0066cc;
    color: white;
    transform: translateY(-2px);
}

#rotationControls button:active {
    transform: translateY(0);
}

@media screen and (max-width: 768px) {
    #rotationControls {
        bottom: 60px;
    }
    
    #rotationControls button {
        padding: 8px 12px;
        font-size: 11px;
    }
}

    </style>
</head>
<body>
    <div class="zoom-notification" id="zoomNotification">
        You have reached the maximum zoom-out level.
    </div>

    <div id="map"></div>
    
    <div class="info-box">
        <h2>üç∫üçæOktoberfest History Map and Recommendationsüçæüç∫</h2>
        <p>Theresienwiese, Munich</p>
    </div>
    <div class="virtual-tour-button" id="virtualTourBtn" title="Take a Virtual Tour of Theresienwiese" style="display: none;">
    üì∑ Loading Tour...
    </div>

    <div id="rotationControls" style="display: none;">
        <button id="rotateLeft" title="Rotate Left">‚Ü∫ Rotate Left</button>
        <button id="rotateRight" title="Rotate Right">Rotate Right ‚Üª</button>
    </div>


    <div class="timeline-slider">
    <h3>Timeline Filter</h3>
    <div class="slider-container">
        <input type="range" id="yearStart" min="1810" max="2024" value="1810" step="1">
        <input type="range" id="yearEnd" min="1810" max="2024" value="2024" step="1">
    </div>
    <div class="year-display">
        <span id="startYear">1810</span> - <span id="endYear">2024</span>
        <span id="eventCount" style="margin-left: 10px; color: #666;"></span>
    </div>
</div>

    <div class="legend-box">
    <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #333;">Legend</h3>
    <div class="legend-item">
        <span class="legend-icon">üê¥</span>
        <span class="legend-text">Horse Racing</span>
    </div>
    <div class="legend-item">
        <span class="legend-icon">üö¥‚Äç‚ôÇÔ∏è</span>
        <span class="legend-text">Bicycle Race</span>
    </div>
    <div class="legend-item">
        <span class="legend-icon">üèõÔ∏è</span>
        <span class="legend-text">Museums</span>
    </div>
    <div class="legend-item">
        <span class="legend-icon">üè∞</span>
        <span class="legend-text">Castles</span>
    </div>
    <div class="legend-item">
        <span class="legend-icon">üé°</span>
        <span class="legend-text">Wheels and Rides</span>
    </div>
    <div class="legend-item">
        <span class="legend-icon">üèÜ</span>
        <span class="legend-text">Championships</span>
    </div>
    <div class="legend-item">
        <span class="legend-icon">üë∫</span>
        <span class="legend-text">Costumes</span>
    </div>
    <div class="legend-item">
        <span class="legend-icon">üßëüèª‚Äçüåæ</span>
        <span class="legend-text">Agricultural Festival</span>
    </div>
    <div class="legend-item">
        <span class="legend-icon">üé¨</span>
        <span class="legend-text">Theater Show</span>
    </div>
    <div class="legend-item">
        <span class="legend-icon">üéà</span>
        <span class="legend-text">Balloonist Landing</span>
    </div>
    <div class="legend-item">
        <span class="legend-icon">üí£</span>
        <span class="legend-text">Bombings</span>
    </div>
    <div class="legend-item">
        <span class="legend-icon">üéµ</span>
        <span class="legend-text">Music</span>
    </div>
    <div class="legend-item">
        <span class="legend-icon">üç∫</span>
        <span class="legend-text">Beer and Scenaries</span>
    </div>
    <div class="legend-item">
        <span class="legend-icon">üëë</span>
        <span class="legend-text">Royal Wedding</span>
    </div>
</div>
    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
       <!-- Georaster libraries -->
    <script src="https://unpkg.com/georaster@1.5.6/dist/georaster.browser.bundle.min.js"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet@3.10.0/dist/georaster-layer-for-leaflet.min.js"></script>
    <script>

        // Set different zoom limits for mobile vs desktop
        const isMobile = window.innerWidth <= 768;
        const minZoomLevel = isMobile ? 12 : 15; // Mobile can zoom out more
        
        // Step 1: Create the map centered on Munich (Theresienwiese - Oktoberfest location)
        // [48.1318, 11.5497] = latitude and longitude
        // 13 = zoom level (higher numbers = more zoomed in)
        const map = L.map('map', {
            minZoom: minZoomLevel, //Users cannot zoom out beyond level 15
            
        });

        //Function to show zoom limit notification
        function showZoomNotification() {
            const notification = document.getElementById('zoomNotification');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000); // Hide after 2 seconds
        }

        //Detect when users hit zoom limit
        map.on('zoomend', function() {
            if (map.getZoom() === map.getMinZoom()) {
                showZoomNotification();
            }
        });
        // Store markers by category for filtering
        const markersByCategory = {};

        // Step 2: Add the tile layer (the actual map images from OpenStreetMap)
        // Define multiple basemap options
const baseMaps = {
    "Streets": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
    }),
    "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '¬© Esri',
        maxZoom: 19
    }),
    "Terrain": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenTopoMap contributors',
        maxZoom: 17
    }),
    "Dark Mode": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© CARTO',
        maxZoom: 19
    })
};

// Add the default basemap (Streets)
baseMaps["Streets"].addTo(map);




        
console.log('Map initialized successfully!');

// Rotation function (defined early so it's available everywhere)
function rotateMap(angle) {
    const mapContainer = document.getElementById('map');
    mapContainer.style.transform = `rotate(${angle}deg)`;
    mapContainer.style.transition = 'transform 0.5s ease';
}

        // Load the GeoJSON file
fetch('MuseumData.geojson')
    .then(response => response.json())
    .then(data => {
        // Add the GeoJSON layer to the map
        // Function to create custom markers with emoji icons and year labels
function createYearMarker(year, category) {
    // Choose emoji and color based on category
    let emoji, color;
    switch(category) {
        case 'Horse Racing': 
            emoji = 'üê¥'; 
            color = '#4ECDC4'; 
            break;
        case 'Bicycle Race': 
            emoji = 'üö¥‚Äç‚ôÇÔ∏è'; 
            color = '#4ECDC4'; 
            break;
        case 'Museums': 
            emoji = 'üèõÔ∏è'; 
            color = '#4ECDC4'; 
            break;
        case 'Castles': 
            emoji = 'üè∞'; 
            color = '#4ECDC4'; 
            break;
        case 'Wheels and Rides': 
            emoji = 'üé°'; 
            color = '#4ECDC4'; 
            break;
        case 'Championships': 
            emoji = 'üèÜ'; 
            color = '#4ECDC4'; 
            break;
        case 'Costumes': 
            emoji = 'üë∫'; 
            color = '#4ECDC4'; 
            break;
        case 'Agricultural Festival': 
            emoji = 'üßëüèª‚Äçüåæ'; 
            color = '#4ECDC4'; 
            break;
        case 'Theater Show': 
            emoji = 'üé¨'; 
            color = '#4ECDC4'; 
            break;
        case 'Balloonist Landing': 
            emoji = 'üéà'; 
            color = '#4ECDC4'; 
            break;
        case 'Bombings': 
            emoji = 'üí£';
            color = '#4ECDC4'; 
            break;
        case 'Food': 
            emoji = 'üçñ'; 
            color = '#FF6B35'; 
            break;
        case 'Music': 
            emoji = 'üéµ'; 
            color = '#4ECDC4'; 
            break;
        case 'Beer and Scenaries': 
            emoji = 'üç∫'; 
            color = '#4ECDC4'; 
            break;
        case 'Royal Wedding': 
            emoji = 'üëë'; 
            color = '#4ECDC4'; 
            break;
        default: 
            emoji = 'üìç'; 
            color = '#0066cc';
    }
    
    return L.divIcon({
        className: 'custom-year-marker',
        html: `<div style="
            background-color: ${color};
            color: white;
            width: 60px;
            height: 70px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
        ">
            <div style="font-size: 24px; margin-bottom: 2px;">${emoji}</div>
            <div style="font-size: 11px;">${year}</div>
        </div>`,
        iconSize: [60, 70],
        iconAnchor: [30, 70]
    });
}
        
        L.geoJSON(data, {
    pointToLayer: function(feature, latlng) {
        const year = feature.properties.Event_Date;
        const category = feature.properties.Category;
        const marker = L.marker(latlng, {
            icon: createYearMarker(year, category)
        });

        // Attach feature data to marker for year filtering
        marker.feature = feature;

        // Store markers by category for filtering
        if (!markersByCategory[category]) {
            markersByCategory[category] = [];
        }
        markersByCategory[category].push(marker);

        return marker;
    },
            onEachFeature: function(feature, layer) {
                const props = feature.properties;
                
                // Create popup content
                const popupContent = `
                    <div style="font-family: Arial; max-width: 300px;">
                        <h3 style="margin: 0 0 10px 0; color: #0066cc;">
                            ${props.Event_Date} - ${props.Event_Name}
                        </h3>
                        ${props.Media_URL ? `
                            <img src="${props.Media_URL}" 
                                 style="width: 100%; height: auto; margin-bottom: 10px; border-radius: 4px;" 
                                 alt="${props.Event_Name}">
                        ` : ''}
                        <p style="margin: 0 0 10px 0; font-size: 14px;">
                            ${props.Event_Description}
                        </p>
                        <p style="margin: 0 0 5px 0; font-size: 12px; color: #666;">
                            <strong>Category:</strong> ${props.Category}
                        </p>
                        ${props.Modern_Recommendations ? `
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 12px;">
                                ${props.Modern_Recommendations}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                layer.bindPopup(popupContent, {
                    maxWidth: 350,
                    minwidth: 300,
                    closeButton: true,
                    autopan: false
                });
            }
        }).addTo(map);
        
        console.log('GeoJSON loaded successfully!');

        // Hide UI elements when popup opens, show when popup closes
map.on('popupopen', function() {
    document.body.classList.add('hide-ui');
});

map.on('popupclose', function() {
    document.body.classList.remove('hide-ui');
});

// Set initial view to show all markers
const allMarkers = [];
Object.values(markersByCategory).forEach(markers => {
    markers.forEach(marker => {
        allMarkers.push(marker);
    });
});
if (allMarkers.length > 0) {
    const group = L.featureGroup(allMarkers);
    map.fitBounds(group.getBounds(), { 
        padding: [50, 50],
        maxZoom: 13
    });
} else {
    // Fallback if no markers loaded
    map.setView([48.1318, 11.5497], 13);
}


// Load GeoTIFF overlay
fetch('Theresienwiese_compressed.tif')
  .then(response => response.arrayBuffer())
  .then(arrayBuffer => {
    parseGeoraster(arrayBuffer).then(georaster => {
      let geoRasterLayer = new GeoRasterLayer({
        georaster: georaster,
        opacity: 0.7,
        resolution: 256
      });
      //Store it globally so Virtual Tour button can access it
    window.theresienweiseLayer = geoRasterLayer;
    window.theresienweiseBounds = georaster.bounds;
    window.tourLayerReady = true;
    window.currentRotation = 0;

    //Update button to show it's ready
    const tourBtn = document.getElementById('virtualTourBtn');
    tourBtn.textContent = 'üì∑ Virtual Tour';
    tourBtn.style.opacity = '1';

// Add to layer control so users can toggle it on/off
baseMaps["Theresienwiese Image"] = geoRasterLayer;



      
      // Add to layer control so users can toggle it on/off
      baseMaps["Theresienwiese Image"] = geoRasterLayer;
      
      // Refresh layer control
      map.eachLayer(layer => {
        if (layer instanceof L.Control.Layers) {
          map.removeLayer(layer);
        }
      });
      L.control.layers(baseMaps).addTo(map);
      
      console.log('GeoTIFF loaded successfully!');
    });
  })
  .catch(error => {
    console.error('Error loading GeoTIFF:', error);
  });


        // Add click handlers to legend items for filtering
const legendItems = document.querySelectorAll('.legend-item');
const activeCategories = new Set();

// Initialize all categories as active
Object.keys(markersByCategory).forEach(category => {
    activeCategories.add(category);
});


// Click legend title to show all categories
document.querySelector('.legend-box h3').addEventListener('click', function() {
    // Clear and re-add all categories
    activeCategories.clear();
    Object.keys(markersByCategory).forEach(category => {
        activeCategories.add(category);
    });
    
    // Remove inactive class from all legend items
    legendItems.forEach(item => {
        item.classList.remove('inactive');
    });
    
    // Show all markers
    Object.values(markersByCategory).forEach(markers => {
        markers.forEach(marker => {
            map.addLayer(marker);
        });
    });
    
    console.log('Showing all categories');
    
    // Zoom out to show all markers
    const allMarkers = [];
    Object.values(markersByCategory).forEach(markers => {
        markers.forEach(marker => {
            allMarkers.push(marker);
        });
    });
    if (allMarkers.length > 0) {
        const group = L.featureGroup(allMarkers);
        map.fitBounds(group.getBounds(), { padding: [50, 50] });
    }
});

// Function to zoom to markers of a specific category
function zoomToCategory(categoryName) {
    if (markersByCategory[categoryName] && markersByCategory[categoryName].length > 0) {
        // Create a bounds object that will contain all markers in this category
        const group = L.featureGroup(markersByCategory[categoryName]);
        // Fit the map to show all markers with some padding
        map.fitBounds(group.getBounds(), { padding: [50, 50] });
    }
}
// Add click event to each legend item
legendItems.forEach(item => {
    item.addEventListener('click', function(event) {
        const categoryName = this.querySelector('.legend-text').textContent;
        
        if (event.ctrlKey || event.metaKey) {
            // Ctrl+Click: Toggle this category (multi-select)
            if (activeCategories.has(categoryName)) {
                // Remove from active
                activeCategories.delete(categoryName);
                this.classList.add('inactive');
                
                // Hide markers
                if (markersByCategory[categoryName]) {
                    markersByCategory[categoryName].forEach(marker => {
                        map.removeLayer(marker);
                    });
                }
            } else {
                // Add to active
                activeCategories.add(categoryName);
                this.classList.remove('inactive');
                
                // Show markers
                if (markersByCategory[categoryName]) {
                    markersByCategory[categoryName].forEach(marker => {
                        map.addLayer(marker);
                    });
                }
            }
        } else {
            // Regular Click: Show ONLY this category
            
            // First, hide all categories
            activeCategories.clear();
            legendItems.forEach(legendItem => {
                legendItem.classList.add('inactive');
            });
            
            // Hide all markers
            Object.values(markersByCategory).forEach(markers => {
                markers.forEach(marker => {
                    map.removeLayer(marker);
                });
            });
            
            // Then, show only the clicked category
            activeCategories.add(categoryName);
            this.classList.remove('inactive');
            
            if (markersByCategory[categoryName]) {
                markersByCategory[categoryName].forEach(marker => {
                    map.addLayer(marker);
                });
            }
            // Zoom to the selected category
zoomToCategory(categoryName);
        }
    });
});

// Timeline slider functionality
const yearStartSlider = document.getElementById('yearStart');
const yearEndSlider = document.getElementById('yearEnd');
const startYearDisplay = document.getElementById('startYear');
const endYearDisplay = document.getElementById('endYear');
const eventCountDisplay = document.getElementById('eventCount');

// Function to filter markers by year range
function filterByYearRange(startYear, endYear) {
    let visibleCount = 0;
    
    // Go through each category
    Object.keys(markersByCategory).forEach(category => {
        // Check if this category is active (selected in legend)
        const isActive = activeCategories.has(category);
        
        // Go through each marker in this category
        markersByCategory[category].forEach(marker => {
            // Get the year from the marker
            const feature = marker.feature;
            const eventYear = parseInt(feature.properties.Event_Date);
            
            // Check if marker should be visible (within year range AND category is active)
            if (eventYear >= startYear && eventYear <= endYear && isActive) {
                map.addLayer(marker);
                visibleCount++;
            } else {
                map.removeLayer(marker);
            }
        });
    });
    
    // Update event count display
    eventCountDisplay.textContent = `(${visibleCount} events)`;
}

// Update start year slider
yearStartSlider.addEventListener('input', function() {
    let startYear = parseInt(this.value);
    let endYear = parseInt(yearEndSlider.value);
    
    // Make sure start year doesn't exceed end year
    if (startYear > endYear) {
        startYear = endYear;
        this.value = startYear;
    }
    
    startYearDisplay.textContent = startYear;
    filterByYearRange(startYear, endYear);
});

// Update end year slider
yearEndSlider.addEventListener('input', function() {
    let endYear = parseInt(this.value);
    let startYear = parseInt(yearStartSlider.value);
    
    // Make sure end year isn't less than start year
    if (endYear < startYear) {
        endYear = startYear;
        this.value = endYear;
    }
    
    endYearDisplay.textContent = endYear;
    filterByYearRange(startYear, endYear);
});

// Initial event count
filterByYearRange(1810, 2024);
    })
    .catch(error => {
        console.error('Error loading GeoJSON:', error);
    });
// Virtual Tour Button - Opens Google Street View of Theresienwiese
// Virtual Tour Button - Toggle Theresienwiese Overlay
let tourActive = false;

document.getElementById('virtualTourBtn').addEventListener('click', function() {
    if (!window.tourLayerReady) {
    alert('Virtual tour is loading... (6.9MB file). Please wait a moment and try again.');
    return;
    }
    
if (tourActive) {
    // Turn OFF virtual tour
    map.removeLayer(window.theresienweiseLayer);
    this.style.backgroundColor = '#0066cc';
    this.innerHTML = 'üì∑ Virtual Tour';
    tourActive = false;

    // Hide rotation controls
    document.getElementById('rotationControls').style.display = 'none';

    // Show basemap again
baseMaps["Streets"].addTo(map);
    
    // Show basemap again
    baseMaps["Streets"].addTo(map);
    
    // Show basemap again
    baseMaps["Streets"].addTo(map);
    
    // Zoom back to show all markers
    const allMarkers = [];
    Object.values(markersByCategory).forEach(markers => {
        allMarkers.push(...markers);
    });
    if (allMarkers.length > 0) {
        const group = L.featureGroup(allMarkers);
        map.fitBounds(group.getBounds(), { 
            padding: [50, 50],
            maxZoom: 13
        });
    }
} else {
    // Turn ON virtual tour
    
    // Hide all basemaps first
    map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer) {
            map.removeLayer(layer);
        }
    });
    
    // Show only Theresienwiese image
    map.addLayer(window.theresienweiseLayer);
    this.style.backgroundColor = '#FF6B35'; // Orange when active
    this.innerHTML = '‚úï Exit Tour';
    tourActive = true;

    // Show rotation controls
    document.getElementById('rotationControls').style.display = 'flex';
    
    // Zoom to fit the overlay
    if (window.theresienweiseBounds) {
        const bounds = [
            [window.theresienweiseBounds[1], window.theresienweiseBounds[0]], // SW corner
            [window.theresienweiseBounds[3], window.theresienweiseBounds[2]]  // NE corner
        ];
        map.fitBounds(bounds, { padding: [30, 30] });
    }
}
// Rotation button handlers
document.getElementById('rotateLeft').addEventListener('click', function() {
    window.currentRotation -= 90;
    if (window.currentRotation < 0) window.currentRotation = 270;
    rotateMap(window.currentRotation);
});

document.getElementById('rotateRight').addEventListener('click', function() {
    window.currentRotation += 90;
    if (window.currentRotation >= 360) window.currentRotation = 0;
    rotateMap(window.currentRotation);
});



});
    </script>
</body>
</html>